<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UnitPay - 支付测试</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .payment-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .platform-select {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .platform-option {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
        }
        .platform-option.selected {
            background-color: #007bff;
            color: white;
            border-color: #0056b3;
        }
        .qr-test-section {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .qr-code-display {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            text-align: center;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-primary:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #545b62;
        }
        .error-message {
            color: #dc3545;
            margin-top: 5px;
        }
        .success-message {
            color: #28a745;
            margin-top: 5px;
        }
        .success-container {
            margin-top: 30px;
        }
        .success-box {
            background-color: #f8fff9;
            border: 1px solid #d1e7dd;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
        }
        .success-icon {
            color: #28a745;
            margin-bottom: 15px;
        }
        .success-box h3 {
            color: #155724;
            margin-bottom: 10px;
        }
        .payment-info-box {
            background-color: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
        }
        .info-item {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }
        .success-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="payment-container">
        <h1>UnitPay 支付测试</h1>
        
        <div class="form-group">
            <label for="walletAddress">钱包地址</label>
            <input type="text" id="walletAddress" placeholder="输入以太坊钱包地址">
        </div>

        <div class="form-group">
            <label for="amount">支付金额</label>
            <input type="number" id="amount" placeholder="输入支付金额" step="0.01" min="0">
        </div>

        <div class="form-group">
            <label for="platform">支付平台</label>
            <select class="form-control" id="platform" name="platform" required>
                <option value="">请选择支付平台</option>
                <option value="WeChat">微信支付</option>
                <option value="Alipay">支付宝</option>
                <option value="GCash">GCash</option>
                <option value="PayPal">PayPal</option>
                <option value="Other">其他</option>
            </select>
        </div>

        <div class="form-group">
            <label for="description">支付描述</label>
            <textarea id="description" placeholder="输入支付描述"></textarea>
        </div>

        <div class="qr-test-section">
            <h3>二维码测试</h3>
            <div class="form-group">
                <label for="qrCodeContent">二维码内容</label>
                <textarea id="qrCodeContent" placeholder="输入或粘贴二维码内容"></textarea>
            </div>
            <div class="qr-code-display" id="qrCodeDisplay">
                <!-- 这里将显示二维码 -->
            </div>
            <button class="btn btn-secondary" onclick="generateTestQR()">生成测试二维码</button>
        </div>

        <div class="form-group">
            <button class="btn btn-primary" id="createPaymentBtn" onclick="createPayment()">创建支付</button>
        </div>

        <div id="message"></div>

        <!-- 支付创建成功消息 -->
        <div id="payment-success" class="success-container hidden">
            <div class="success-box">
                <div class="success-icon">
                    <svg viewBox="0 0 24 24" width="48" height="48" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                </div>
                <h3>支付创建成功！</h3>
                <p>您的支付已成功创建，请点击下面的链接查看详情</p>
                <div class="payment-info-box">
                    <div class="info-item">
                        <span>支付ID：</span>
                        <strong id="success-payment-id"></strong>
                    </div>
                    <div class="info-item">
                        <span>金额：</span>
                        <strong id="success-amount"></strong>
                    </div>
                </div>
                <div class="success-actions">
                    <a id="view-payment-link" class="btn btn-primary" href="#">查看支付详情</a>
                    <button class="btn btn-secondary" onclick="resetForm()">创建新支付</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script>
        // 连接Socket.io
        const socket = io();
        
        // 平台选择
        const platformOptions = document.querySelectorAll('.platform-option');
        let selectedPlatform = '';
        
        platformOptions.forEach(option => {
            option.addEventListener('click', () => {
                platformOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                selectedPlatform = option.dataset.platform;
                document.getElementById('selectedPlatform').value = selectedPlatform;
                console.log('Selected platform:', selectedPlatform);
            });
        });

        // 生成测试二维码
        function generateTestQR() {
            const platform = selectedPlatform || 'WeChat';
            const amount = document.getElementById('amount').value;
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                showMessage('请先输入有效的支付金额', 'error');
                return;
            }

            // 平台代码映射
            const platformMap = {
                'WeChat': 'W',
                'Alipay': 'A',
                'GCash': 'G',
                'PayPal': 'P'
            };
            
            // 使用简化格式的数据
            const testData = {
                p: platformMap[platform] || 'W',
                m: 'TEST_MERCHANT_' + Date.now(),
                n: '测试商户',
                a: 'TEST_ACCOUNT_' + Date.now(),
                v: parseFloat(amount).toFixed(2)
            };
            
            // 转换为JSON字符串
            const qrContent = JSON.stringify(testData);
            console.log('Generated QR Content:', qrContent);
            
            document.getElementById('qrCodeContent').value = qrContent;
            
            // 清除旧的二维码
            const qrDisplay = document.getElementById('qrCodeDisplay');
            qrDisplay.innerHTML = '';
            
            // 显示二维码
            QRCode.toCanvas(qrDisplay, qrContent, {
                width: 200,
                margin: 1,
                color: {
                    dark: '#000000',
                    light: '#ffffff'
                }
            }, function(error) {
                if (error) {
                    console.error('生成二维码失败:', error);
                    showMessage('生成二维码失败', 'error');
                }
            });
        }

        // 创建支付
        async function createPayment() {
            const createPaymentBtn = document.getElementById('createPaymentBtn');
            createPaymentBtn.disabled = true;
            createPaymentBtn.textContent = '创建中...';
            
            try {
                const walletAddress = document.getElementById('walletAddress').value;
                const amount = document.getElementById('amount').value;
                const platform = document.getElementById('platform').value;
                const qrCodeContent = document.getElementById('qrCodeContent').value;
                const description = document.getElementById('description').value;
                
                // 验证输入
                if (!walletAddress || !amount) {
                    showMessage('请填写钱包地址和支付金额', 'error');
                    createPaymentBtn.disabled = false;
                    createPaymentBtn.textContent = '创建支付';
                    return;
                }
                
                if (!platform && !qrCodeContent) {
                    showMessage('请选择支付平台或提供二维码内容', 'error');
                    createPaymentBtn.disabled = false;
                    createPaymentBtn.textContent = '创建支付';
                    return;
                }
                
                // 验证钱包地址格式
                if (!/^0x[a-fA-F0-9]{40}$/.test(walletAddress)) {
                    showMessage('无效的以太坊钱包地址', 'error');
                    createPaymentBtn.disabled = false;
                    createPaymentBtn.textContent = '创建支付';
                    return;
                }
                
                // 验证金额
                const parsedAmount = parseFloat(amount);
                if (isNaN(parsedAmount) || parsedAmount <= 0) {
                    showMessage('无效的支付金额，金额必须大于0', 'error');
                    createPaymentBtn.disabled = false;
                    createPaymentBtn.textContent = '创建支付';
                    return;
                }
                
                // 构建支付数据
                const paymentData = {
                    walletAddress: walletAddress,
                    amount: parsedAmount,
                    platform: platform,
                    description: description || '测试支付'
                };
                
                // 如果有二维码内容，添加到支付数据
                if (qrCodeContent) {
                    paymentData.qrContent = qrCodeContent;
                }
                
                // 发送API请求创建支付
                const response = await fetch('/api/payment-intents', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(paymentData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || '创建支付失败');
                }
                
                const responseData = await response.json();
                console.log('支付创建成功:', responseData);
                
                // 显示成功界面
                showSuccessView(responseData);
            } catch (error) {
                console.error('创建支付错误:', error);
                showMessage(error.message || '创建支付失败，请重试', 'error');
                createPaymentBtn.disabled = false;
                createPaymentBtn.textContent = '创建支付';
            }
        }
        
        // 显示成功界面
        function showSuccessView(data) {
            // 隐藏表单
            document.querySelector('.payment-container').querySelectorAll('div.form-group, div.qr-test-section').forEach(el => {
                el.style.display = 'none';
            });
            
            // 更新成功信息
            document.getElementById('success-payment-id').textContent = data.id;
            document.getElementById('success-amount').textContent = `${data.amount} USDT`;
            
            // 设置支付详情链接
            const viewPaymentLink = document.getElementById('view-payment-link');
            viewPaymentLink.href = `/payment-detail?id=${data.id}`;
            
            // 显示成功界面
            document.getElementById('payment-success').classList.remove('hidden');
        }
        
        // 重置表单
        function resetForm() {
            // 显示表单
            document.querySelector('.payment-container').querySelectorAll('div.form-group, div.qr-test-section').forEach(el => {
                el.style.display = 'block';
            });
            
            // 重置表单字段
            document.getElementById('walletAddress').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('platform').value = '';
            document.getElementById('description').value = '';
            document.getElementById('qrCodeContent').value = '';
            
            // 清除二维码显示
            document.getElementById('qrCodeDisplay').innerHTML = '';
            
            // 隐藏成功界面
            document.getElementById('payment-success').classList.add('hidden');
            
            // 重置按钮
            document.getElementById('createPaymentBtn').disabled = false;
            document.getElementById('createPaymentBtn').textContent = '创建支付';
        }

        // 显示消息
        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.className = type + '-message';
        }
    </script>
</body>
</html> 